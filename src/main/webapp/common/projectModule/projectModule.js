"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}();!function(e,t){function i(e,i,r,n,a,o,s,l){var u=function(){var t=this;this.url="api/project",a.ServiceModel.call(this,this.url),this.getProjectCollectionNameById=function(t){return e.get("/api/projectcollection/"+t+"/name")},this.getProject=function(t){return e.get("/api/projectcollection/"+t+"/project")},this.getReadMe=function(i,r){return e.get(t.url+"/readme/"+i+"/"+r)},this.getBuildList=function(t){return e.get("/api/ci/build/"+t)},this.getBranches=function(i){return e.get(t.url+"/branches/"+i)},this.getBranchesWithoutId=function(i,r,n){return e.get(t.url+"/branches/"+n+"/"+i+"/"+r)},this.getTags=function(i){return e.get(t.url+"/tags/"+i)},this.getTagsWithoutId=function(i,r,n){return e.get(t.url+"/tags/"+n+"/"+i+"/"+r)},this.getGitLabInfo=function(){return e.get(t.url+"/git/gitlabinfo")},this.getGitLabInfo=function(i){return e.get(t.url+"/git/gitlabinfo/"+i)},this.getBuildDockerfile=function(t,i){return e.get("/api/ci/build/dockerfile/"+t+"/"+i)},this.previewDockerfile=function(t){return e.post("/api/ci/build/dockerfile",angular.toJson(t),{notIntercept:!0})},this.build=function(t){return e.post("/api/ci/build/start",angular.toJson(t),{notIntercept:!0})},this.stopBulid=function(t){return e.get("/api/ci/build/stop/"+t)},this.modifyCreator=function(i,r){return e.post(t.url+"/creator/"+i,angular.toJson(r))},this.modifyCodeInfo=function(i,r){return e.put(t.url+"/"+i+"/git/gitlabinfo",angular.toJson(r))},this.buildInfoList=function(t,i,r){return e.get("/api/ci/buildInfo/"+t+"/page?page="+i+"&count="+r)}},c=new u,g=function(e,t){return s.open({animation:!0,templateUrl:"/index/tpl/modal/buildModal/buildModal.html",controller:"BuildModalCtr as vm",size:"md",resolve:{projectInfo:{projectId:e,hasCodeInfo:t}}}).result},m=function(){function e(){_classCallCheck(this,e),this.imageInfo={compileIsPublic:1,runIsPublic:1},this.selectedCompileImage={},this.selectedRunImage={},this.currentCompileList=[],this.privateRegistryImageList=[],this.selectedCompilePrivateImageTag={},this.currentCompilePrivateImageTagList=[],this.selectedRunPrivateImageTag={},this.currentRunPrivateImageTagList=[],this.currentRunList=[],this.projectImagesInfo={compilePublicImageList:[],compilePrivateImageList:[],runPublicImageList:[],runPrivateImageList:[]},this.userList=[]}return _createClass(e,[{key:"init",value:function(e){e||(e={}),i.isArray(e.compilePublicImageList)||(e.compilePublicImageList=[]),i.isArray(e.compilePrivateImageList)?e.compilePrivateImageList=this.privateRegistryImageList:e.compilePrivateImageList=[],i.isArray(e.runPublicImageList)||(e.runPublicImageList=[]),i.isArray(e.runPrivateImageList)?e.runPrivateImageList=this.privateRegistryImageList:e.runPrivateImageList=[],angular.forEach(e,function(e,r){var n=!0,a=!1,o=t;try{for(var s,l=e[Symbol.iterator]();!(n=(s=l.next()).done);n=!0){var u=s.value;u.createDate=i.getPageDate(u.createTime),u.imageTxt=u.imageName,u.imageTag&&(u.imageTxt+=":"+u.imageTag)}}catch(e){a=!0,o=e}finally{try{!n&&l.return&&l.return()}finally{if(a)throw o}}}),this.projectImagesInfo=e,0===Object.keys(this.selectedCompileImage).length&&(this.toggleIsPublicImage("compile"),this.toggleIsPublicImage("run"))}},{key:"getForBuildImageAsPrivateImageList",value:function(e){var t=this;l.imageService.getForBuildImages().then(function(r){for(var n=r.data.result||[],a=[],o=0;o<n.length;o++){var s=n[o];s.createDate=i.getPageDate(s.createTime),s.imageTxt=s.imageName,s.registryUrl=s.registry,s.registryType=0,s.imageTag&&(s.imageTxt+=":"+s.imageTag),a.push(s)}"compile"===e?t.projectImagesInfo.compilePrivateImageList=a:"run"===e?t.projectImagesInfo.runPrivateImageList=a:"all"===e&&(t.privateRegistryImageList=a)}).finally(function(){})}},{key:"getPrivateImageTag",value:function(e,t){var i=this;l.imageService.getImageTags(t.imageName,t.registryUrl).then(function(t){var r=t.data.result;"compile"===e?i.currentCompilePrivateImageTagList=r:"run"===e&&(i.currentRunPrivateImageTagList=r)}).finally(function(){})}},{key:"toggleIsPublicImage",value:function(e,t){void 0===t&&(t="compile"==e?this.imageInfo.compileIsPublic:this.imageInfo.runIsPublic),"compile"==e?(this.currentCompileList=1===t?this.projectImagesInfo.compilePublicImageList:this.projectImagesInfo.compilePrivateImageList,this.toggleImage("compile",0)):(this.currentRunList=1===t?this.projectImagesInfo.runPublicImageList:this.projectImagesInfo.runPrivateImageList,this.toggleImage("run",0))}},{key:"togglePrivateImageTag",value:function(e,t,i){if("compile"===e){this.selectedCompilePrivateImageTag=this.currentCompilePrivateImageTagList[t];for(var r=0;r<this.currentCompileList.length;r++)if(this.currentCompileList[r].imageName===i.imageName){this.currentCompileList[r].imageTag=this.selectedCompilePrivateImageTag.tag;break}}else if("run"===e){this.selectedRunPrivateImageTag=this.currentRunPrivateImageTagList[t];for(var n=0;n<this.currentRunList.length;n++)if(this.currentRunList[n].imageName===i.imageName){this.currentRunList[n].imageTag=this.selectedRunPrivateImageTag.tag;break}}}},{key:"toggleImage",value:function(e,t,i){if("compile"===e)if(0===this.imageInfo.compileIsPublic||void 0===i){this.selectedCompilePrivateImageTag={},void 0===i&&(i=this.currentCompileList[0]);for(var r=0;r<this.currentCompileList.length;r++){var n=this.currentCompileList[r];if(n.imageTxt==i.imageTxt){this.selectedCompileImage=n;break}}this.getPrivateImageTag("compile",i)}else if(void 0!==i)for(var a=0;a<this.currentCompileList.length;a++){var o=this.currentCompileList[a];if(o.imageTxt==i.imageTxt){this.selectedCompileImage=o;break}}else this.selectedCompileImage=this.currentCompileList[t];else if("run"===e)if(0===this.imageInfo.runIsPublic||void 0===i){this.selectedRunPrivateImageTag={},void 0===i&&(i=this.currentRunList[0]);for(var s=0;s<this.currentRunList.length;s++){var l=this.currentRunList[s];if(l.imageTxt==i.imageTxt){this.selectedRunImage=l;break}}this.getPrivateImageTag("run",i)}else if(void 0!==i)for(var u=0;u<this.currentRunList.length;u++){var c=this.currentRunList[u];if(c.imageTxt==i.imageTxt){this.selectedRunImage=c;break}}else this.selectedRunImage=angular.copy(this.currentRunList[t])}},{key:"toggleSpecifiedImage",value:function(e,t){var r="";i.isObject(t)?(r=t.imageName,t.imageTag&&(r+=":"+t.imageTag)):t={},"compile"==e?(this.selectedCompileImage=t,this.selectedCompileImage.imageTxt=r,this.selectedCompilePrivateImageTag.tag=t.imageTag,this.imageInfo.compileIsPublic=void 0!==t.registryType?t.registryType:1,this.currentCompileList=1===this.imageInfo.compileIsPublic?this.projectImagesInfo.compilePublicImageList:this.projectImagesInfo.compilePrivateImageList):(this.selectedRunImage=t,this.selectedRunImage.imageTxt=r,this.selectedRunPrivateImageTag.tag=t.imageTag,this.imageInfo.runIsPublic=void 0!==t.registryType?t.registryType:1,this.currentRunList=1===this.imageInfo.compileIsPublic?this.projectImagesInfo.runPublicImageList:this.projectImagesInfo.runPrivateImageList)}}]),e}(),f=function(){function r(e){_classCallCheck(this,r),this.config={},this.customConfig={},this.isUseCustom=!1,this.isDefDockerfile=!1,this.projectImagesIns=new m,this.init(e)}return _createClass(r,[{key:"init",value:function(e){i.isObject(e)||(e={}),this.customConfig={},i.isObject(e.dockerfileInfo)||(e.dockerfileInfo={}),i.isObject(e.dockerfileConfig)||(e.dockerfileConfig={}),e.exclusiveBuild?(this.customConfig=e.exclusiveBuild,this.isUseCustom=!0,this.isDefDockerfile=!1):e.userDefineDockerfile?(this.customConfig=e.dockerfileInfo,this.isUseCustom=!1,this.isDefDockerfile=!1):e.customDockerfile?(this.customConfig=e.customDockerfile,this.isUseCustom=!1,this.isDefDockerfile=!0):(this.customConfig=e.dockerfileConfig,this.isUseCustom=!1,this.isDefDockerfile=!1),this.autoBuildInfo=angular.copy(e.autoBuildInfo),e.autoBuildInfo=function(){var t=e.autoBuildInfo,r=void 0,n=void 0;if(!i.isObject(t))return{tag:0,master:!1,other:!1,branches:""};if(n=e.autoBuildInfo.branches,r={tag:t.tag||0,master:!1,other:!1,branches:""},n){for(var a=0;a<n.length;a++)"master"==n[a]&&(r.master=!0,n.splice(a,1),a--);0!==n.length&&(r.other=!0,r.branches=n.join(","))}return r}(),e.confFiles=function(){var r=e.confFiles,n=[];if(!i.isObject(r))return[{tplDir:"",originDir:""}];var a=!0,o=!1,s=t;try{for(var l,u=Object.keys(r)[Symbol.iterator]();!(a=(l=u.next()).done);a=!0){var c=l.value;n.push({tplDir:c,originDir:r[c]})}}catch(e){o=!0,s=e}finally{try{!a&&u.return&&u.return()}finally{if(o)throw s}}return n.push({tplDir:"",originDir:""}),n}(),i.isArray(e.envConfDefault)||(e.envConfDefault=[]),e.envConfDefault.push({key:"",value:"",description:""}),this.customConfig.compileEnv=function(){var e=this.customConfig.compileEnv;if(!e)return[{envName:"",envValue:""}];if("string"!=typeof e)return angular.copy(e);var t=e.split(","),i=t.map(function(e){var t=e.split("=");return{envName:t[0],envValue:t[1]}});return i.push({envName:"",envValue:""}),i}.bind(this)(),this.customConfig.uploadFileInfos=function(e){return e||(e=[]),e.length||e.push({filename:"",content:""}),e}(this.customConfig.uploadFileInfos),this.customConfig.createdFileStoragePath=function(){var e=this.customConfig.createdFileStoragePath;if(!i.isArray(e)||0===e.length)return[{name:""}];var t=e.map(function(e){return{name:e}});return t.push({name:""}),t}.bind(this)(),this.config=e}},{key:"resetConfig",value:function(){this.config.dockerfileConfig=null,this.config.dockerfileInfo=null,this.config.exclusiveBuild=null,this.config.confFiles=null,this.config.envConfDefault=null,this.config.autoBuildInfo=this.autoBuildInfo,this.init(this.config)}},{key:"deleteArrItem",value:function(e,t){this.config[e].splice(t,1)}},{key:"deleteCompileEnv",value:function(e){this.customConfig.compileEnv.splice(e,1)}},{key:"deleteCreatedFileStoragePath",value:function(e){this.customConfig.createdFileStoragePath.splice(e,1)}},{key:"addEnvConfDefault",value:function(){this.config.envConfDefault.push({key:"",value:"",description:""})}},{key:"addUploadFileInfo",value:function(){this.customConfig.uploadFileInfos.push({filename:"",content:""})}},{key:"delUploadFileInfo",value:function(e){this.customConfig.uploadFileInfos.splice(e,1)}},{key:"toggleBaseImage",value:function(e,t,i){this.customConfig.baseImageName=e,this.customConfig.baseImageTag=t,this.customConfig.baseImageRegistry=i}},{key:"addCreatedFileStoragePath",value:function(){this.customConfig.createdFileStoragePath.push({name:""})}},{key:"addCompileEnv",value:function(){this.customConfig.compileEnv.push({envName:"",envValue:""})}},{key:"addConfFiles",value:function(){this.config.confFiles.push({tplDir:"",originDir:""})}},{key:"modify",value:function(){return e.put("/api/project",angular.toJson(this._formartProject()))}},{key:"delete",value:function(){var e=this,t=o.defer();return n.danger("确认删除","确认要删除吗？").then(function(e){if(e!==n.button.BUTTON_OK)throw""}).then(function(){c.deleteData(e.config.id).then(function(){n.alert("提示","删除成功！"),t.resolve()},function(e){dalog.error("删除失败！",e.data.resultMsg),t.reject("fail")})},function(){t.reject("dismiss")}),t.promise}},{key:"getDockerfile",value:function(){var e=this,t=function(){s.open({animation:!0,templateUrl:"/index/tpl/modal/dockerfileModal/dockerfileModal.html",controller:"DockerfileModalCtr as vm",size:"md",resolve:{project:e}})};if(this.config.userDefineDockerfile){s.open({templateUrl:"/index/tpl/modal/branchCheckModal/branchCheckModal.html",controller:"BranchCheckModalCtr as vm",size:"md",resolve:{codeInfo:function(){return e.config.codeInfo},projectId:function(){return e.config.id}}}).result.then(function(i){e.config.dockerfileInfo.branch=e.config.dockerfileInfo.tag=null,e.config.dockerfileInfo[i.type]=i.value,t()})}else t()}},{key:"_formartProject",value:function(){var e={},i="",r=[],n=angular.copy(this.config),a=angular.copy(this.customConfig);return n.envConfDefault=function(){var e=[],i=!0,r=!1,a=t;try{for(var o,s=n.envConfDefault[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;l.key&&l.value&&e.push({key:l.key,value:l.value,description:l.description})}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}return e}(),n.autoBuildInfo=function(){var e=n.autoBuildInfo,t=void 0;return n.codeInfo&&(e.other||e.master||e.tag)?(t={tag:e.tag,branches:[]},e.other&&(t.branches=e.branches.split(",")),e.master&&t.branches.push("master"),t):null}(),n.userDefineDockerfile?(e.name=n.name,e.id=n.id,n.codeInfo&&(e.codeInfo=n.codeInfo,e.autoBuildInfo=n.autoBuildInfo),e.exclusiveBuild=null,e.userDefineDockerfile=n.userDefineDockerfile,e.dockerfileInfo=n.dockerfileInfo,e.authority=n.authority,e.envConfDefault=n.envConfDefault):(n.dockerfileInfo&&(n.dockerfileInfo=null),n.confFiles=function(){var e={},i=!0,r=!1,a=t;try{for(var o,s=n.confFiles[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;l.tplDir&&l.originDir&&(e[l.tplDir]=l.originDir)}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}return e}(),i=function(){var e=[],i=!0,r=!1,n=t;try{for(var o,s=a.compileEnv[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;l.envName&&l.envValue&&e.push(l.envName+"="+l.envValue)}}catch(e){r=!0,n=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw n}}return e.join(",")}(),r=function(){var e=[],i=!0,r=!1,n=t;try{for(var o,s=a.createdFileStoragePath[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;l.name&&e.push(l.name)}}catch(e){r=!0,n=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw n}}return e}(),this.isUseCustom?(n.dockerfileConfig=null,n.customDockerfile=null,n.exclusiveBuild={customType:a.customType,compileImage:this.projectImagesIns.selectedCompileImage,runImage:this.projectImagesIns.selectedRunImage,codeStoragePath:a.codeStoragePath,compileEnv:i,compileCmd:a.compileCmd,createdFileStoragePath:r,workDir:a.workDir,user:a.user,runFileStoragePath:this.projectImagesIns.selectedRunImage.runFileStoragePath,startCmd:this.projectImagesIns.selectedRunImage.startCommand},this.projectImagesIns.selectedCompileImage.imageName||(n.exclusiveBuild.compileImage=this.customConfig.compileImage,n.exclusiveBuild.runImage=this.customConfig.runImage,n.exclusiveBuild.runFileStoragePath=this.customConfig.runFileStoragePath,n.exclusiveBuild.startCmd=this.customConfig.startCmd)):this.isDefDockerfile?(n.exclusiveBuild=null,n.dockerfileConfig=null,n.customDockerfile={dockerfile:a.dockerfile,uploadFileInfos:a.uploadFileInfos.filter(function(e){return e.filename||e.content})}):(n.exclusiveBuild=null,n.customDockerfile=null,n.dockerfileConfig={baseImageName:a.baseImageName,baseImageTag:a.baseImageTag,baseImageRegistry:a.baseImageRegistry,installCmd:a.installCmd,codeStoragePath:a.codeStoragePath,compileEnv:i,compileCmd:a.compileCmd,workDir:a.workDir,startCmd:a.startCmd,user:a.user}),e=n),e}},{key:"create",value:function(t){var i=this._formartProject();return e.post("/api/projectcollection/"+t+"/project",angular.toJson(i))}}]),r}(),h=a.instancesCreator({Project:f,ProjectImages:m});return{projectService:c,getInstance:h,buildProject:g}}var r=angular.module("projectModule",[]);i.$inject=["$http","$util","$state","dialog","$LunarModel","$q","$modal","$LunarImage"],r.factory("$LunarProject",i),e.projectModule=r}(window);