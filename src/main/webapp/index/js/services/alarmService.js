"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _get=function t(e,i,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:t(n,i,r)}if("value"in o)return o.value;var s=o.get;if(void 0!==s)return s.call(r)},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}();!function(t,e){void 0!==t&&t.factory("$LunarAlarm",["$LunarModel","$LunarUser","$LunarDeploy","$LunarCluster","$http","$LunarPublic","dialog","$q","$util",function(t,e,i,r,o,n,s,a,l){var u=function(){t.ServiceModel.call(this,"/api/alarm/template")},c=function(){t.ServiceModel.call(this,"/api/alarm/hostgroup"),this.addHost=function(t,e){return o.post("/api/alarm/hostgroup/bind/"+t,angular.toJson(e))},this.deleteHost=function(t,e){return o.delete("/api/alarm/hostgroup/bind/"+t+"/"+e)}},h=function(){t.ServiceModel.call(this,"/api/alarm/usergroup"),this.getUserGroup=function(){return o.get("/api/alarm/usergroup")},this.createUserGroup=function(t){return o.post("/api/alarm/usergroup",angular.toJson(t))},this.bindUser=function(t,e){return o.post("/api/alarm/usergroup/bind/"+t,angular.toJson(e))},this.deleteUserGroup=function(t){return o.delete("/api/alarm/usergroup/"+t)},this.updateUserGroup=function(t){return o.put("/api/alarm/usergroup",angular.toJson(t))},this.deleteSingleUser=function(t,e){return o.delete("/api/alarm/usergroup/bind/"+t+"/"+e)}},p=r.getInstance("ClusterService"),f=new u,g={metric:{cpu_percent:{text:"CPU占用率",unit:"%",belong:"all"},memory_percent:{text:"内存占用率",unit:"%",belong:"all"},disk_percent:{text:"磁盘占用率",tagName:"分区",unit:"%",belong:"host"},disk_read:{text:"磁盘读取",tagName:"设备",unit:"KB/s",belong:"host"},disk_write:{text:"磁盘写入",tagName:"设备",unit:"KB/s",belong:"host"},network_in:{text:"网络流入",tagName:"网卡",unit:"KB/s",belong:"all"},network_out:{text:"网络流出",tagName:"网卡",unit:"KB/s",belong:"all"},agent_alive:{text:"agent存活",belong:"host"}},aggregateType:{avg:"平均值",max:"最大值",min:"最小值",sum:"和值"},aggregateTypeAgent:{max:"全部",min:"至少一次"}},d=function(){function t(e){_classCallCheck(this,t),this.config={},this.hostGroupList=[],this.keyMaps=g,this.groupList=[],this.deployListIns=i.getInstance("DeployList"),this.loadingIns=n.getLoadingInstance(),this.clusterList=[],this.init(e)}return _createClass(t,[{key:"init",value:function(t){l.isObject(t)||(t={templateType:"host"}),l.isObject(t.deploymentInfo)||(t.deploymentInfo={}),l.isArray(t.strategyList)||(t.strategyList=[]),l.isObject(t.callback)||(t.callback={}),l.isArray(t.hostGroupList)||(t.hostGroupList=[]);var e=!0,i=!1,r=void 0;try{for(var o,n=t.strategyList[Symbol.iterator]();!(e=(o=n.next()).done);e=!0){var s=o.value;"disk_percent"==s.metric?s.tag=s.tag.substring(6):s.metric.indexOf("disk")!==-1?s.tag=s.tag.substring(7):s.metric.indexOf("network")!==-1&&(s.tag=s.tag.substring(6))}}catch(t){i=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(i)throw r}}this.config=t,void 0===this.config.id&&(this.config.deploymentInfo.hostEnv||(this.config.deploymentInfo.hostEnv="PROD"),this.addStrategy())}},{key:"initHostGroupList",value:function(){var t=this,e=void 0,i=function(){var e=t.config.hostGroupList,i=void 0;if(e&&0===e.length){var r=!0,o=!1,n=void 0;try{for(var s,a=t.hostGroupList[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){s.value.isSelected=!1}}catch(t){o=!0,n=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw n}}}else for(var l=0,u=t.hostGroupList.length;l<u;l++){i=!1;for(var c=0,h=e.length;c<h;c++)if(e[c].id===t.hostGroupList[l].id){i=!0;break}t.hostGroupList[l].isSelected=i}};0===this.hostGroupList.length?(this.loadingIns.startLoading("hostgroup"),e=new c,e.getData().then(function(e){t.hostGroupList=e.data.result||[],i()},function(){s.error("警告","获取主机组信息失败！")}).finally(function(){t.loadingIns.finishLoading("hostgroup")})):i()}},{key:"initGroupList",value:function(){var t=this,e=this.config.userGroupList,i=function(){var i=void 0;if(e&&0!==e.length)for(var r=0,o=t.groupList.length;r<o;r++){i=!1;for(var n=0,s=e.length;n<s;n++)if(t.groupList[r].id===e[n].id){i=!0;break}t.groupList[r].isSelected=i}else for(var a=0,l=t.groupList.length;a<l;a++)t.groupList[a].isSelected=!1};0===this.groupList.length?(this.loadingIns.startLoading("groupList"),o.get("/api/alarm/usergroup").then(function(e){t.groupList=e.data.result||[],i()},function(){s.error("警告","获取组信息失败！")}).finally(function(){t.loadingIns.finishLoading("groupList")})):i()}},{key:"initDeployAndClusterList",value:function(){var t=this,e=this.config.deploymentInfo;0===this.deployListIns.deployList.length?(this.loadingIns.startLoading("deploy"),a.all([i.deployService.getList(),p.getData()]).then(function(i){t.deployListIns.init(i[0].data.result),t.clusterList=i[1].data.result||[],e.clusterName?(t.toggleHostEnv(e.hostEnv),t.deployListIns.deploy.id=e.id,t.deployListIns.deploy.name=e.deploymentName):(e.clusterName=t.clusterList[0].name,t.toggleCluster(t.clusterList[0].name))},function(){s.error("警告","获取信息失败！")}).finally(function(){t.loadingIns.finishLoading("deploy")})):(this.toggleHostEnv(e.hostEnv),this.deployListIns.deploy.id=e.id,this.deployListIns.deploy.name=e.deploymentName)}},{key:"toggleTemplateType",value:function(t){t!==this.config.templateType&&(this.config.templateType=t,this.config.strategyList=[],this.addStrategy())}},{key:"addStrategy",value:function(){this.config.strategyList.push({metric:"cpu_percent",tag:"",pointNum:3,aggregateType:"avg",operator:">=",rightValue:null,note:"",maxStep:3})}},{key:"deleteStrategy",value:function(t){this.config.strategyList.splice(t,1)}},{key:"toggleStrategyMetric",value:function(t,e){var i=this.config.strategyList[t];i.metric!==e&&("agent_alive"===e&&(i.aggregateType="max"),i.metric=e,i.tag="")}},{key:"toggleHostEnv",value:function(t){this.config.deploymentInfo.hostEnv=t,this.deployListIns.filterDeploy(this.config.deploymentInfo.clusterName,t)}},{key:"toggleCluster",value:function(t){this.config.deploymentInfo.clusterName=t,this.deployListIns.filterDeploy(t,this.config.deploymentInfo.hostEnv)}},{key:"getFormartConfig",value:function(){var t={};if(t.templateName=this.config.templateName,t.templateType=this.config.templateType,t.id=this.config.id,"host"==t.templateType){t.templateType=this.config.templateType,t.hostGroupList=[];for(var e=0,i=this.hostGroupList.length;e<i;e++)this.hostGroupList[e].isSelected&&t.hostGroupList.push({id:this.hostGroupList[e].id})}else"deploy"==t.templateType&&(t.deploymentInfo={id:this.deployListIns.deploy.id,clusterName:this.config.deploymentInfo.clusterName,deploymentName:this.deployListIns.deploy.name,hostEnv:this.config.deploymentInfo.hostEnv});t.strategyList=[];var r=!0,o=!1,n=void 0;try{for(var s,a=this.config.strategyList[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var l=s.value,u=angular.copy(l);"agent_alive"==u.metric&&(u.rightValue=1,u.operator="<"),u.tag&&("disk_percent"==u.metric?u.tag="mount="+u.tag:u.metric.indexOf("disk")!==-1?u.tag="device="+u.tag:u.metric.indexOf("network")!==-1&&(u.tag="iface="+u.tag)),t.strategyList.push(u)}}catch(t){o=!0,n=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw n}}t.userGroupList=[];for(var c=0,h=this.groupList.length;c<h;c++)this.groupList[c].isSelected&&t.userGroupList.push({id:this.groupList[c].id});return t.callback=angular.copy(this.config.callback),console.log(t),t}},{key:"create",value:function(){return f.setData(this.getFormartConfig())}},{key:"modify",value:function(){return f.updateData(this.getFormartConfig())}}]),t}(),y=function(t){function e(t,i){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"nodeList"));return r.selectedList=[],r.init(t,i),r}return _inherits(e,t),_createClass(e,[{key:"init",value:function(t,i){if(t||(t=this.nodeList),i||(i=this.clusterName),t&&i){this.clusterName=i;var r=!0,o=!1,n=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var l=s.value,u=!0,c=!1,h=void 0;try{for(var p,f=this.selectedList[Symbol.iterator]();!(u=(p=f.next()).done);u=!0){var g=p.value;if(g.cluster===i&&g.name===l.name){l.isSelected=!0;break}}}catch(t){c=!0,h=t}finally{try{!u&&f.return&&f.return()}finally{if(c)throw h}}l.isSelected||(l.isSelected=!1)}}catch(t){o=!0,n=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw n}}_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"init",this).call(this,t)}}},{key:"initSelectedList",value:function(){this.selectedList=[],this.checkAllItem(!1)}},{key:"checkAllItem",value:function(t){if(_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"checkAllItem",this).call(this,t),t){var i=!0,r=!1,o=void 0;try{for(var n,s=this.nodeList[Symbol.iterator]();!(i=(n=s.next()).done);i=!0){var a=n.value;if(a.isSelected){var l=!1,u=!0,c=!1,h=void 0;try{for(var p,f=this.selectedList[Symbol.iterator]();!(u=(p=f.next()).done);u=!0){var g=p.value;if(this.clusterName===g.cluster&&a.name===g.name){l=!0;break}}}catch(t){c=!0,h=t}finally{try{!u&&f.return&&f.return()}finally{if(c)throw h}}l||this.selectedList.push({name:a.name,ip:a.ip,cluster:this.clusterName})}}}catch(t){r=!0,o=t}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}}else{var d=!0,y=!1,m=void 0;try{for(var v,L=this.nodeList[Symbol.iterator]();!(d=(v=L.next()).done);d=!0)for(var b=v.value,k=0;k<this.selectedList.length;k++){var _=this.selectedList[k];if(this.clusterName===_.cluster&&b.name===_.name){this.selectedList.splice(k,1),k--;break}}}catch(t){y=!0,m=t}finally{try{!d&&L.return&&L.return()}finally{if(y)throw m}}}}},{key:"toggleCheck",value:function(t,i){if(_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"toggleCheck",this).call(this,t,i),i)t.cluster=this.clusterName,this.selectedList.push({name:t.name,ip:t.ip,cluster:t.cluster});else for(var r=0;r<this.selectedList.length;r++)if(this.selectedList[r].name===t.name&&this.selectedList[r].cluster===this.clusterName){this.selectedList.splice(r,1);break}}},{key:"deleteSelectedNode",value:function(t){if(t.cluster===this.clusterName){var i=!0,r=!1,o=void 0;try{for(var n,s=this.nodeList[Symbol.iterator]();!(i=(n=s.next()).done);i=!0){var a=n.value;if(a.name===t.name){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"toggleCheck",this).call(this,a,!1);break}}}catch(t){r=!0,o=t}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}}for(var l=0;l<this.selectedList.length;l++)if(this.selectedList[l].name===t.name&&this.selectedList[l].cluster===t.cluster){this.selectedList.splice(l,1);break}}},{key:"filterWithKey",value:function(t){this.selectedCount=0,this.isCheckAll=!0;var e=!0,i=!1,r=void 0;try{for(var o,n=this.nodeList[Symbol.iterator]();!(e=(o=n.next()).done);e=!0){var s=o.value;if(s.keyFilter=s.name.indexOf(t)!==-1,s.keyFilter){var a=!0,l=!1,u=void 0;try{for(var c,h=this.selectedList[Symbol.iterator]();!(a=(c=h.next()).done);a=!0){var p=c.value;if(p.name===s.name&&p.cluster===this.clusterName){s.isSelected=!0,this.selectedCount++;break}}}catch(t){l=!0,u=t}finally{try{!a&&h.return&&h.return()}finally{if(l)throw u}}s.isSelected||(s.isSelected=!1,this.isCheckAll&&(this.isCheckAll=!1))}else s.isSelected=!1}}catch(t){i=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(i)throw r}}0===this.selectedCount&&(this.isCheckAll=!1)}}]),e}(t.SelectListModel);return{getInstance:t.instancesCreator({NodeList:y,AlarmService:u,HostGroupService:c,AlarmTemplate:d,UserGroupService:h}),alarmEventService:{getData:function(){return o.get("/api/alarm/event")},ignore:function(t){return o.post("/api/alarm/event/ignore",t)}},keyMaps:g}}])}(angular.module("LunarApp"));