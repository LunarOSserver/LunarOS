"use strict";!function(t,e){void 0!==t&&t.factory("$LunarCluster",["$http","$q","$modal","dialog","$LunarModel","$util",function(t,e,i,n,r,o){var s=function(){var i=this;this.url="/api/cluster",r.ServiceModel.call(this,this.url);var o=this.deleteData;this.getNamespace=function(e){return t.get(i.url+"/"+e+"/namespace")},this.setNamespace=function(e,n){return t.post(i.url+"/"+e+"/namespace",angular.toJson(n))},this.getLabels=function(e){return t.get(i.url+"/"+e+"/labels")},this.createWatcher=function(e,n){return t.post(i.url+"/"+e+"/watcher/create",angular.toJson(n))},this.getWatcher=function(e){return t.get(i.url+"/"+e+"/watcher/status")},this.getDeployList=function(){return t.get("/api/deploy/list")},this.getInitWatcherVersion=function(e){return t.get("/api/version/id/"+e+"/1")},this.deleteData=function(t){var i=e.defer();return n.danger("确认删除","确认要删除吗？").then(function(t){if(t!==n.button.BUTTON_OK)throw""}).then(function(){o(t).then(function(){n.alert("提示","删除成功！"),i.resolve()},function(t){n.error("删除失败",t.data.resultMsg),i.reject()})},function(){i.reject()}),i.promise},this.getInstancesList=function(e){return t.get(i.url+"/"+e+"/instancelist")}},l=function(){var e=this;s.call(this),this.getNodeList=function(i){return t.get(e.url+"/"+i+"/nodelist")},this.getNodeListWoPods=function(i){return t.get(e.url+"/"+i+"/nodelistwithoutpods")},this.getNodeInfo=function(i,n){return t.get(e.url+"/"+i+"/node/"+n)},this.getHostInstances=function(i,n){return t.get(e.url+"/"+i+"/nodelist/"+n)},this.updateDisk=function(i,n,r){return t.post(e.url+"/"+i+"/"+n+"/disk?path="+r)},this.addLabel=function(i,n){return t.post(e.url+"/"+i+"/nodelabels/add",angular.toJson(n))},this.deleteLabel=function(i,n){return t.post(e.url+"/"+i+"/nodelabels/delete",angular.toJson(n))},this.modifyNodeDisk=function(i,n,r){return t.post(e.url+"/"+i+"/"+n+"/disk?path="+r)},this.getLabels=function(i){return t.get(e.url+"/"+i+"/labels")}},a=function(t,e){this.isCheckAll=!1,this.nodeList=[],this.selectedCount=0,this.labelsInfo={},this.init(t,e)};a.prototype={init:function(t,e){var i=this;e!==!0&&(e=!1),this.nodeList=function(){t=t?t:[];for(var i=0;i<t.length;i++)!e||t[i].diskInfo?(t[i].keyFilter=!0,t[i].labelFilter=!0,t[i].isSelected=!1):(t.splice(i,1),i--);return t}(),this.labelsInfo=function(){for(var t={},e=i.nodeList,n=0,r=e.length;n<r;n++)for(var o in e[n].labels)if(e[n].labels.hasOwnProperty(o)&&"kubernetes.io/hostname"!=o&&"hostEnv"!=o)if(t[o]){for(var s=!1,l=0,a=t[o].contents.length;l<a;l++)if(t[o].contents[l]===e[n].labels[o]){s=!0;break}s||t[o].contents.push(e[n].labels[o])}else t[o]={contents:[e[n].labels[o]],isSelected:!1,isShow:!0};return t.PRODENV?t.PRODENV.isShow=!1:t.PRODENV={isShow:!1,contents:[],isSelected:!1},t.TESTENV?t.TESTENV.isShow=!1:t.TESTENV={isShow:!1,contents:[],isSelected:!1},t.BUILDENV?t.BUILDENV.isShow=!1:t.BUILDENV={isShow:!1,contents:[],isSelected:!1},t}()},initLabelsInfo:function(){for(var t in this.labelsInfo)this.labelsInfo.hasOwnProperty(t)&&this.labelsInfo[t].isSelected&&(this.labelsInfo[t].isSelected=!1);this.toggleLabelNodes()},toggleEnv:function(t){"PROD"!=t&&"TEST"!=t||(this.labelsInfo.TESTENV.isSelected="PROD"!=t,this.labelsInfo.PRODENV.isSelected="PROD"==t),this.toggleLabelNodes()},toggleNodeCheck:function(t){var e=!0;if(t.isSelected){this.selectedCount++;var i=!0,n=!1,r=void 0;try{for(var o,s=this.nodeList[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;if(l.keyFilter&&l.labelFilter&&!l.isSelected){e=!1;break}}}catch(t){n=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(n)throw r}}e&&(this.isCheckAll=!0)}else this.selectedCount--,this.isCheckAll=!1},filterWithKey:function(t){this.isCheckAll=!1,this.selectedCount=0;var e=!0,i=!1,n=void 0;try{for(var r,o=this.nodeList[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var s=r.value;s.isSelected=!1,s.keyFilter=s.name.indexOf(t)!==-1}}catch(t){i=!0,n=t}finally{try{!e&&o.return&&o.return()}finally{if(i)throw n}}},checkAllNode:function(t){this.isCheckAll=void 0===t?this.isCheckAll:t,this.selectedCount=0;var e=!0,i=!1,n=void 0;try{for(var r,o=this.nodeList[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var s=r.value;s.keyFilter&&s.labelFilter&&this.isCheckAll?(s.isSelected=!0,this.selectedCount++):s.isSelected=!1}}catch(t){i=!0,n=t}finally{try{!e&&o.return&&o.return()}finally{if(i)throw n}}},toggleLabel:function(t,e){if(this.labelsInfo[t]){if(void 0!==e){if(this.labelsInfo[t].isSelected===e)return;this.labelsInfo[t].isSelected=e}else this.labelsInfo[t].isSelected=!this.labelsInfo[t].isSelected;this.toggleLabelNodes()}},toggleLabelNodes:function(){var t=!1;if(this.isCheckAll=!1,this.selectedCount=0,angular.forEach(this.labelsInfo,function(e){!t&&e.isSelected&&(t=!0)}),t){var e=!0,i=!1,n=void 0;try{for(var r,o=this.nodeList[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var s=r.value,l=!0;s.isSelected=!1;for(var a in this.labelsInfo)if(this.labelsInfo.hasOwnProperty(a)&&this.labelsInfo[a].isSelected&&void 0===s.labels[a]){l=!1;break}s.labelFilter=l}}catch(t){i=!0,n=t}finally{try{!e&&o.return&&o.return()}finally{if(i)throw n}}}else{var c=!0,u=!1,f=void 0;try{for(var h,d=this.nodeList[Symbol.iterator]();!(c=(h=d.next()).done);c=!0){var g=h.value;g.isSelected=!1,g.labelFilter=!0}}catch(t){u=!0,f=t}finally{try{!c&&d.return&&d.return()}finally{if(u)throw f}}}},showHost:function(){var t=this;return i.open({animation:!0,templateUrl:"/index/tpl/modal/hostListModal/hostListModal.html",controller:"HostListModalCtr",size:"lg",resolve:{hostList:function(){return t.nodeList}}}).result},getFormartSelectedLabels:function(){var t=[];return angular.forEach(this.labelsInfo,function(e,i){if(e.isSelected)for(var n=0,r=e.contents.length;n<r;n++)t.push({name:i,content:e.contents[n]})}),t},getSelectedNodes:function(){var t=[],e=!0,i=!1,n=void 0;try{for(var r,o=this.nodeList[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var s=r.value;s.isSelected&&t.push(s.name)}}catch(t){i=!0,n=t}finally{try{!e&&o.return&&o.return()}finally{if(i)throw n}}return t}};var c=function(t){this.etcdValid=!0,this.zookeeperValid=!0,this.kafkaValid=!0,this.config={},this.init(t)};c.prototype={constructor:c,init:function(t){var e=[],i=void 0,n=[],r=void 0,s=[],l=void 0;if(o.isObject(t)||(t={}),"string"==typeof t.etcd){i=t.etcd.split(",");for(var a=0,c=i.length;a<c;a++)""!==i[a]&&e.push({name:i[a]})}if(e.push({name:""}),t.etcd=e,o.isObject(t.clusterLog)||(t.clusterLog={}),"string"==typeof t.clusterLog.zookeeper){r=t.clusterLog.zookeeper.split(",");for(var u=0,f=r.length;u<f;u++)""!==r[u]&&n.push({name:r[u]})}if(n.push({name:""}),t.clusterLog.zookeeper=n,"string"==typeof t.clusterLog.kafka){l=t.clusterLog.kafka.split(",");for(var h=0,d=l.length;h<d;h++)""!==l[h]&&s.push({name:l[h]})}s.push({name:""}),t.clusterLog.kafka=s,t.isHttps=void 0!==t.api&&0===t.api.indexOf("https://"),t.isHttps&&(t.api=t.api.substring(8)),t.logConfig||(t.logConfig=0),this.config=t},addEtcd:function(){this.config.etcd.push({name:""})},addKafka:function(){this.config.clusterLog.kafka.push({name:""})},addZookeeper:function(){this.config.clusterLog.zookeeper.push({name:""})},deleteArrItem:function(t,e){this.config[t].splice(e,1)},deleteLogArrItem:function(t,e){this.config.clusterLog[t].splice(e,1)},toggleUser:function(t){"[object Object]"===Object.prototype.toString.call(t)&&(this.config.ownerName=t.name)},toggleLogConfig:function(){this.config.logConfig=1===this.config.logConfig?0:1},validItem:function(t){var e=!1;if("etcd"!=t&&0===this.config.logConfig)e=!0;else for(var i="etcd"==t?this.config.etcd:this.config.clusterLog[t]||[],n=0,r=i.length;n<r;n++)if(i[n].name&&""!==i[n].name){e=!0;break}switch(t){case"etcd":this.etcdValid=e;break;case"zookeeper":this.zookeeperValid=e;break;case"kafka":this.kafkaValid=e}return e},modify:function(){return t.put("/api/cluster",angular.toJson(this._formartCluster()))},_formartCluster:function(){var t=angular.copy(this.config),e="",i="",n="",r=!0,o=!1,s=void 0;try{for(var l,a=t.etcd[Symbol.iterator]();!(r=(l=a.next()).done);r=!0){var c=l.value;c.name&&(e+=c.name+",")}}catch(t){o=!0,s=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw s}}if(t.etcd=e,0===t.logConfig)t.clusterLog=null;else{var u=!0,f=!1,h=void 0;try{for(var d,g=t.clusterLog.zookeeper[Symbol.iterator]();!(u=(d=g.next()).done);u=!0){var v=d.value;v.name&&(i+=v.name+",")}}catch(t){f=!0,h=t}finally{try{!u&&g.return&&g.return()}finally{if(f)throw h}}t.clusterLog.zookeeper=i;var p=!0,b=!1,y=void 0;try{for(var m,L=t.clusterLog.kafka[Symbol.iterator]();!(p=(m=L.next()).done);p=!0){var k=m.value;k.name&&(n+=k.name+",")}}catch(t){b=!0,y=t}finally{try{!p&&L.return&&L.return()}finally{if(b)throw y}}t.clusterLog.kafka=n}return t.isHttps?t.api="https://"+t.api:t.username=t.password=void 0,t.isHttps=void 0,t},_formartNewCluster:function(t){var e={};return e.clusterInfo=t,e},create:function(){var e=this._formartCluster(),i=this._formartNewCluster(e);return t.post("/api/cluster",angular.toJson(i.clusterInfo))}};var u=function(t){this.cluster={},this.clusterList=[],this.init(t)};return u.prototype={init:function(t){this.clusterList=t||[]},toggleCluster:function(t){this.cluster.id=this.clusterList[t].id,this.cluster.name=this.clusterList[t].name}},{getInstance:r.instancesCreator({ClusterList:u,Cluster:c,NodeList:a,ClusterService:s,NodeService:l})}}])}(angular.module("LunarApp"));